# Loop Replay Feature - Technical Plan

## Brief Description
Enable users to replay parts of the song an arbitrary number of times with two selection modes: 1) manually select lyric cards to play in loop with configurable repeat count, and 2) manually select a time period (e.g. 5 second to 34 second) to loop with repeat count. Users should be able to easily turn off the loop and reset the state.

## Files and Functions to Change

### `/src/types/lyrics.ts`
- **Add `LoopState` interface** with fields:
  - `isActive: boolean` - whether loop mode is currently active
  - `mode: 'lyrics' | 'time' | null` - selection mode
  - `startTime: number` - loop start time in milliseconds
  - `endTime: number` - loop end time in milliseconds
  - `selectedLyricIndices: number[]` - array of selected lyric line indices for lyrics mode
  - `repeatCount: number` - number of times to loop (0 = infinite)
  - `currentIteration: number` - current iteration count
- **Add `LyricsLineProps` extension** with selection state fields:
  - `isSelected?: boolean` - whether line is selected for looping
  - `onLineSelect?: (index: number, selected: boolean) => void` - selection callback

### `/src/components/LoopControls.tsx` (new component)
- **Create loop control interface** with mode selection buttons, time range inputs, repeat count controls
- **Add props interface** with callbacks for loop state changes
- **Implement mode switching logic** between lyrics selection and time selection
- **Add repeat count input** with validation (1-999, or 0 for infinite)
- **Add time range pickers** for manual time selection mode
- **Add reset/clear button** to exit loop mode
- **Add start/stop loop button** to activate configured loop

### `/src/components/LyricsLine.tsx`
- **Add selection state styling** with checkmark or highlight for selected lines
- **Add `isSelected` prop** to component interface
- **Add `onLineSelect` prop** for selection callback
- **Implement selection click handler** that toggles line selection when in lyrics loop mode
- **Add multi-select visual feedback** with distinct styling from regular click-to-seek
- **Update cursor behavior** to show selection cursor when in lyrics selection mode

### `/src/components/LyricsDisplay.tsx`
- **Add loop mode props** including `loopState` and selection callbacks
- **Pass loop selection props** to each `LyricsLineComponent`
- **Add visual indicators** for loop start/end boundaries when in time selection mode
- **Implement range selection logic** for time-based mode
- **Add loop status indicator** showing current iteration and remaining loops

### `/src/components/AudioPlayer.tsx`
- **Add loop logic to time update handlers** in both demo and real audio modes
- **Implement loop boundary detection** checking if current time exceeds loop end time
- **Add automatic seek back to loop start** when boundary is reached
- **Update `AudioPlayerRef` interface** with loop control methods:
  - `setLoopRegion: (startTime: number, endTime: number) => void`
  - `clearLoop: () => void`
  - `getLoopState: () => LoopState`
- **Add loop iteration counting** and automatic stop when repeat count reached
- **Handle loop state persistence** through seek operations and play/pause

### `/src/hooks/useLoopState.ts` (new hook)
- **Create loop state management hook** with reducer pattern
- **Implement lyrics selection logic** converting selected line indices to time range
- **Add time range validation** ensuring start < end and within song duration
- **Implement loop iteration tracking** and automatic reset logic
- **Add helper functions** for calculating loop bounds from lyric selection
- **Export state update actions** for components to dispatch

### `/src/App.tsx`
- **Add loop state management** using `useLoopState` hook
- **Pass loop state and callbacks** to `LyricsDisplay` and `LoopControls`
- **Connect loop controls to AudioPlayer** via ref for loop region management
- **Add loop status to UI** showing active loop information
- **Implement loop reset handler** that clears all loop state

## Algorithm

### Lyrics Selection Mode Flow
1. **User enters lyrics selection mode** → `LoopControls` sets mode to 'lyrics'
2. **User clicks lyric lines** → `LyricsLineComponent` calls `onLineSelect(index, !isSelected)`
3. **Selection state updates** → `useLoopState` adds/removes index from `selectedLyricIndices`
4. **Calculate time range** → Find min `startTime` and max `endTime` from selected lyrics
5. **User sets repeat count** → `LoopControls` updates `repeatCount` in state
6. **User starts loop** → `App` calls `audioPlayerRef.setLoopRegion(startTime, endTime)`
7. **Audio loops automatically** → `AudioPlayer` seeks to start when reaching end time

### Time Selection Mode Flow
1. **User enters time selection mode** → `LoopControls` sets mode to 'time'
2. **User inputs start/end times** → `LoopControls` validates and updates state
3. **Visual feedback shows range** → `LyricsDisplay` highlights affected lyric lines
4. **User sets repeat count** → Update `repeatCount` in loop state
5. **User starts loop** → Apply time range to `AudioPlayer` loop logic
6. **Audio loops within range** → Automatic seek back when reaching end boundary

### Loop Execution Algorithm
1. **Monitor current time** → `AudioPlayer` checks time in update handlers
2. **Detect loop boundary** → `if (currentTime >= loopState.endTime && loopState.isActive)`
3. **Check iteration count** → `if (currentIteration < repeatCount || repeatCount === 0)`
4. **Seek to loop start** → `audioRef.current.currentTime = loopState.startTime / 1000`
5. **Increment iteration** → `currentIteration++`
6. **Auto-stop if complete** → `if (currentIteration >= repeatCount && repeatCount > 0)` then clear loop

### Loop Reset Flow
1. **User clicks reset** → `LoopControls` calls `onResetLoop()`
2. **Clear all state** → `useLoopState` resets to initial state
3. **Clear audio loop** → `audioPlayerRef.clearLoop()` removes loop boundaries
4. **Reset visual indicators** → All selection highlighting and loop UI disappears
5. **Resume normal playback** → Audio continues without loop constraints

## Technical Implementation Details
- **State management**: Use reducer pattern in `useLoopState` for complex state transitions
- **Time precision**: All loop boundaries use millisecond precision for accuracy
- **Visual feedback**: Selected lyrics get distinct styling from active/hover states
- **Mobile support**: Touch selection works for lyric line selection
- **Loop persistence**: Loop state survives seek operations and play/pause actions
- **Performance**: Minimize re-renders during loop execution with memo and callbacks
- **Validation**: Ensure loop regions are within song bounds and start < end
